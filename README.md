## å¾®ä¿¡å°ç¨‹åºç”Ÿæˆæµ·æŠ¥

  æ•ˆæœå›¾ï¼š
    ![Alt](https://github.com/github-gmm/weapp-qrcode-demo/blob/main/lib/1.png)

### æ•ˆæœ
ä¸Šé¢çš„å›¾ç‰‡æ˜¯ä»¿ç…§å¾®ä¿¡çš„ä¸ªäººåç‰‡ç”Ÿæˆçš„æµ·æŠ¥ï¼ˆæ¯”è¾ƒç²—ç³™ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¿«é€Ÿç”Ÿæˆï¼Œè¾¾åˆ°æ•ˆæœï¼‰ï¼Œè¯¥æµ·æŠ¥åŒ…æ‹¬ï¼šèƒŒæ™¯å›¾ç‰‡ï¼Œæ–‡å­—ï¼ŒäºŒç»´ç ç­‰ä¿¡æ¯ã€‚æ„Ÿå…´è¶£çš„è¯·ç»§ç»­å¾€ä¸‹çœ‹ğŸ‘‡ 

è¯¥demoå®ç°äº†ä¸‹é¢å‡ ä¸ªåŠŸèƒ½ï¼š
- åŠ¨æ€çš„äºŒç»´ç 
- åŠ¨æ€ç”Ÿæˆæµ·æŠ¥
- å¯ä»¥è‡ªå®šä¹‰è½¬å‘ç»™å¥½å‹
- ä¿å­˜æµ·æŠ¥åˆ°å›¾åº“

### æ€è·¯
> éœ€æ±‚è¯´æ˜

é¡¹ç›®ä¸Šå‡†å¤‡åœ¨ç°æœ‰çš„å°ç¨‹åºï¼ˆå°é«˜ï¼‰ä¸Šå¼€å‘é‚€è¯·æ–°ç”¨æˆ·ä¼˜æƒ æ´»åŠ¨åŠŸèƒ½ï¼Œé‚€è¯·æˆåŠŸä»¥åé‚€è¯·è€…å’Œè¢«é‚€è¯·è€…éƒ½å¯ä»¥è·å–ä¸€å¼ æŠ˜æ‰£åˆ¸ã€‚
1. `ç”Ÿæˆä¸€å¼ æµ·æŠ¥åˆ†äº«åˆ°æœ‹å‹å’Œæœ‹å‹åœˆ`
2. `è½¬å‘é“¾æ¥ç»™æœ‹å‹å’Œç¾¤èŠ`

> åç³Ÿæ–‡æ¡£å’Œç™¾åº¦

å¾®ä¿¡å¼€æ”¾æ–‡æ¡£ä»‹ç»çš„æ¯”è¾ƒæ¨¡æ£±ä¸¤å¯ï¼Œå¦‚æœä»æœªå¼€å‘è¿‡å°ç¨‹åºçš„åˆšä¸Šæ‰‹ä¼šè§‰å¾—éå¸¸éº»çƒ¦ï¼ŒåŸºæœ¬ä¸Šéœ€è¦å»ç™¾åº¦ä¸Šçœ‹åˆ«äººä»‹ç»çš„ï¼›å¼€å‘è¿‡å°ç¨‹åºçš„ä¹Ÿéœ€è¦ä¸æ–­çš„å»è°ƒè¯•é‡Œé¢æä¾›æ–¹æ³•ï¼Œæœ‰äº›å†™çš„ä¹Ÿæ˜¯ä¸å¯¹çš„åœ°æ–¹æœ‰æ—¶æ ¹æœ¬ä¹Ÿæ‰¾ä¸å‡ºã€‚

soï¼Œå¤§å®¶éƒ½ä¼šæ‰“å¼€ç™¾åº¦ï¼Œåšå®¢ï¼Œå»æœèµ„æ–™ï¼›æœåˆ°äº†å¾ˆå¤šå¤§é‡é‡å¤çš„èµ„æ–™ï¼Œå¤§æµ·æé’ˆçš„ä¸€ä¸ªä¸€ä¸ªçœ‹è‡ªå·±éœ€è¦çš„ã€‚

> å…¶ä»–æ–‡ç« ä»‹ç»å¦‚ä½•ç”Ÿæˆæµ·æŠ¥å¯ä»¥å‚è€ƒ

- https://github.com/Pudon/weapp-qrcode-base64
- https://juejin.cn/post/6913802456900042766

### ä»£ç å®ç°
- [x] éš¾ç‚¹1ï¼šå¦‚ä½•ç”Ÿæˆä½ æƒ³è¦çš„äºŒç»´ç ï¼Ÿï¼ˆè¿™é‡Œçš„äºŒç»´ç ï¼Œæˆ‘è®¤ä¸ºçš„æ˜¯å¯ä»¥é€šè¿‡æ‰«ç è·³åˆ°è‡ªå·±å°ç¨‹åºé¡µé¢å¹¶æºå¸¦å‚æ•°çš„ï¼‰

- [x] éš¾ç‚¹2ï¼šå¦‚ä½•ä½¿ç”¨ç”»å¸ƒï¼Œç”»å‡ºä½ æƒ³è¦çš„æµ·æŠ¥ï¼Ÿ
> ç”ŸæˆäºŒç»´ç 

é€šè¿‡weapp.qrcode.jså¯ä»¥ç”Ÿæˆä¸¤ç§å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶ï¼Œä¸€ç§æ˜¯base64çš„äºŒç»´ç ï¼Œä¸€ç§æ˜¯åœ¨canvasä½œç”»ä¿å­˜åœ¨å¾®ä¿¡ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶çš„äºŒç»´ç ã€‚é€šè¿‡å®éªŒæ¯”è¾ƒï¼Œç¬¬äºŒç§æ›´åŠ ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œæˆ‘å°è¯•ç€æŠŠè¿™ä¸¤ç§ç”Ÿæˆçš„äºŒç»´ç æ”¾åœ¨ä¸€å—æ–°çš„ç”»å¸ƒä¸Šï¼Œç¬¬ä¸€ç§ä¼šæç¤ºæŠ¥é”™äº†ã€‚

```
äºŒç»´ç ç”Ÿæˆæ’ä»¶çš„åŸç†ï¼š
    1ã€å®šä¹‰ä¸€å—2dçš„ç”»å¸ƒ type=2d
    2ã€è·å–canvasç”»å¸ƒçš„å…ƒç´  createSelectorQuery
    3ã€è°ƒç”¨äºŒç»´ç æ’ä»¶çš„æ–¹æ³• drawQrcode
    4ã€è·å–canvasåœ¨å°ç¨‹åºçš„ä¸´æ—¶å›¾ç‰‡è·¯å¾„ canvasToTempFilePath
```

wxml ç”»å¸ƒå®šä¹‰ï¼šå¯è§†ç•Œé¢ä¸å¯è§ï¼Œåªæƒ³æ‹¿åˆ°å›¾ç‰‡è·¯å¾„å±•ç¤º

```
<canvas     
    type="2d"     
    style="width: 75px; height: 75px; position: absolute; left: -200px;"     
    id="myQrcode">  
</canvas>
```

å°è£…æˆå…¬å…±äºŒç»´ç æ–¹æ³•

```
// å¼•ç”¨æ’ä»¶
const drawQrcode = require("../lib/weapp.qrcode.min.js");

// ç”ŸæˆäºŒç»´ç ç”»å¸ƒ
const getQrCodeToCanvas = text => {  
    return new Promise((resolve) => {  
        // è·å–ç”»å¸ƒdomå…ƒç´ 
        const query = wx.createSelectorQuery()    
        query.select('#myQrcode').fields({      
            node: true,      
            size: true    
        }).exec((res) => {      
            var canvas = res[0].node      
            // è°ƒç”¨æ–¹æ³•drawQrcodeç”ŸæˆäºŒç»´ç       
            drawQrcode({        
                canvas: canvas,        
                canvasId: 'myQrcode',        
                width: 75,        
                padding: 10,        
                background: '#ffffff',        
                foreground: '#000000',        
                text: text,      
            })      
            // è·å–ä¸´æ—¶è·¯å¾„ï¼ˆå¾—åˆ°ä¹‹åï¼Œæƒ³å¹²å˜›å°±å¹²å˜›äº†ï¼‰      
            wx.canvasToTempFilePath({        
                canvasId: 'myQrcode',        
                canvas: canvas,        
                x: 0,        
                y: 0,        
                width: 75,        
                height: 75,        
                destWidth: 150,        
                destHeight: 150,        
                success(res) {          
                    resolve(res.tempFilePath)        
                },      
            })    
        })  
    })
}
```

é¡µé¢è°ƒç”¨

```
bindToQrCode() {
    util.getQrCodeToCanvas(this.data.inputValue).then(url=> {
        console.log('å›¾ç‰‡', url)
        this.setData({
            qrcodeURL: url
        })
    })
},
```

psï¼šå¦‚æœæƒ³è¦ç”Ÿæˆå¸¦æœ‰å›¾ç‰‡çš„äºŒç»´ç ï¼Œåªéœ€åœ¨drawQrcodeæ–¹æ³•é‡Œé¢åŠ å…¥imageå±æ€§

```
// ç”ŸæˆäºŒç»´ç ç”»å¸ƒ
const getQrCodeToCanvas = text => {
  return new Promise((resolve) => {
    const query = wx.createSelectorQuery()
    query.select('#myQrcode').fields({
      node: true,
      size: true
    }).exec((res) => {
      var canvas = res[0].node
      // æ’å…¥å›¾ç‰‡
      var img = canvas.createImage();
      img.src = "/lib/bg.jpg"
      img.onload = function () {
        // è°ƒç”¨æ–¹æ³•drawQrcodeç”ŸæˆäºŒç»´ç 
        drawQrcode({
          canvas: canvas,
          canvasId: 'myQrcode',
          width: 150,
          padding: 0,
          marign: 0,
          background: '#ffffff',
          foreground: '#000000',
          text: text,
          // å®šä¹‰å›¾ç‰‡çš„å¤§å°
          image: {
            imageResource: img,
            width: 40, // å»ºè®®ä¸è¦è®¾ç½®è¿‡å¤§ï¼Œä»¥å…å½±å“æ‰«ç 
            height: 40, // å»ºè®®ä¸è¦è®¾ç½®è¿‡å¤§ï¼Œä»¥å…å½±å“æ‰«ç 
            round: true // Logoå›¾ç‰‡æ˜¯å¦ä¸ºåœ†å½¢
          }
        })
        // è·å–ä¸´æ—¶è·¯å¾„ï¼ˆå¾—åˆ°ä¹‹åï¼Œæƒ³å¹²å˜›å°±å¹²å˜›äº†ï¼‰
        wx.canvasToTempFilePath({
          canvasId: 'myQrcode',
          canvas: canvas,
          x: 0,
          y: 0,
          width: 150,
          height: 150,
          destWidth: 300,
          destHeight: 300,
          success(res) {
            resolve(res.tempFilePath)
          },
        })
      }
    })
  })
}
```
> ç”Ÿæˆæµ·æŠ¥

è¿˜åŸä¸Šé¢demoçš„å›¾ç‰‡ï¼ŒäºŒç»´ç åŠ¨æ€ç”Ÿæˆï¼Œå›¾ç‰‡æ˜¯é¡¹ç›®é‡Œé¢çš„

```
æµç¨‹ï¼šä»ä¸Šåˆ°ä¸‹ï¼Œä»å·¦åˆ°å³
    1ã€å®šä¹‰ç”»å¸ƒ canvas-id=canvas
    2ã€è·å–åŠ¨æ€äºŒç»´ç  getQrCodeToCanvas
    3ã€è·å–ç”»å¸ƒçš„å¯¹è±¡ createCanvasContext (å»ºè®®ä½¿ç”¨createSelectorQuery)
    4ã€æŠŠå›¾ç‰‡ï¼Œå­—ï¼ŒäºŒç»´ç æ”¾åœ¨ç”»å¸ƒçš„ä½ç½®
```

wxmlç”»å¸ƒå®šä¹‰

```
<canvas canvas-id="canvas"
    style="width: {{width}}px; height: {{height}}px;">
</canvas>
```

è°ƒç”¨æ–¹æ³•
```
/**
   * ç”Ÿå‘½å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ
   */
  onReady: function () {
    util.getQrCodeToCanvas('æ¬¢è¿åŠ å…¥å°ç¨‹åºå¼€å‘ï½').then(qrUrl=> {
      // åˆ›å»ºç”»å¸ƒ
      const ctx = wx.createCanvasContext('canvas')
      // èƒŒæ™¯é»‘è‰²
      ctx.rect(0, 0, this.data.width, this.data.height)
      ctx.fill()
      ctx.draw(true)
      // ç™½è‰²æ‰“åº•
      ctx.rect(20, 100, this.data.width - 40, this.data.height - 200)
      ctx.setFillStyle('white')
      ctx.fill()
      ctx.draw(true)
      // æ–‡å­—å¡«å……
      ctx.setFontSize(18)
      ctx.setFillStyle('black')
      ctx.fillText('åƒè‚‰é•¿è‚‰è‚‰', 130, 155)
      ctx.setFontSize(14)
      ctx.setFillStyle('#636363')
      ctx.fillText('æ¹–å— é•¿æ²™', 130, 180)
      ctx.draw(true)
      ctx.setFontSize(14)
      ctx.setFillStyle('#636363')
      ctx.fillText('æ‰«ä¸€æ‰«ä¸Šé¢çš„äºŒç»´ç å›¾æ¡ˆï¼ŒåŠ æˆ‘å¾®ä¿¡', 70, this.data.height - 120)
      ctx.draw(true)
      // ç”¨æˆ·å›¾ç‰‡
      ctx.drawImage('../../lib/bg.jpg', 40, 120, 80, 80)
      // äºŒç»´ç å›¾ç‰‡
      ctx.drawImage(qrUrl, 50, 215, this.data.width - 110, this.data.height - 360)
      ctx.draw(true, ()=>{
        let that = this;
        // è·å–å›¾ç‰‡è·¯å¾„
        wx.canvasToTempFilePath({
          x: 0,
          y: 0,
          width: that.data.canvasW,
          height: that.data.canvasH,
          destWidth: that.data.canvasW * 2,
          destHeight: that.data.canvasH * 2,
          canvasId: 'canvas',
          success(res) {
            that.setData({
              pictureUrl:  res.tempFilePath, //ä»…ä¸ºç¤ºä¾‹ï¼Œå¹¶éçœŸå®çš„èµ„æº
            })
          }
        })
      })
    })
  },
```


> æ–‡æ¡£é“¾æ¥

- [weapp-qrcode-canvas-2d](https://developers.weixin.qq.com/community/develop/article/doc/000e88e73a415835ed9b46d7956013)
- [canvas](https://developers.weixin.qq.com/miniprogram/dev/api/canvas/wx.createCanvasContext.html)
- [è½¬å‘](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onshareappmessageobject-object)
- [ä¿å­˜ç…§ç‰‡åˆ°å›¾åº“](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.saveImageToPhotosAlbum.html)

### æ€»ç»“

1. å¦‚ä½•è·å–weapp.qrcode.min.jsæ’ä»¶ï¼Ÿè¯·å»gitHubä¸Šä¸‹è½½è¯¥æ–‡ä»¶
2. ç”»å¸ƒidå’Œä½ è°ƒç”¨æ–¹æ³•çš„å‚æ•°å¿…é¡»ä¿æŒä¸€è‡´æ‰èƒ½è°ƒç”¨
3. çœŸæœºè°ƒè¯•æŠ¥é”™ï¼Ÿ2dç”»å¸ƒåªæ”¯æŒé¢„è§ˆï¼Œä¸æ”¯æŒçœŸæœº
4. ä¸ºä»€ä¹ˆä¸åŒæ—¶ç”Ÿæˆå¸¦æœ‰äºŒç»´ç çš„æµ·æŠ¥ï¼Ÿæš‚æ—¶æ²¡æ‰¾åˆ°æ–¹æ³•ï¼Œæ¯•ç«ŸäºŒç»´ç çš„æ’ä»¶ä¹Ÿæ˜¯è°ƒç”¨å®˜æ–¹çš„çš„ğŸ˜­ï¼Œç†è§£ï¼šåº”è¯¥éœ€è¦æ”¹å†™è¯¥æ’ä»¶

